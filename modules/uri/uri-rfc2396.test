# -*- tcl -*-
# ------------------------------------------------------------------------------

source [file join \
	[file dirname [file dirname [file join [pwd] [info script]]]] \
	devtools testutilities.tcl]

testsNeedTcl     8.2
testsNeedTcltest 1.0

testing {
    useLocal uri.tcl uri
}

# ------------------------------------------------------------------------------
# 2016-12-17 revisions
# ------------------------------------------------------------------------------
# (1) Test result corrected to match RFC 3986 Sec. 5.4.1 for tests:
#     uri-rfc2396-1.7 uri-rfc2396-1.9 uri-rfc2396-2.7 uri-rfc2396-2.9
# (2) Add tests uri-rfc2396-1.14a uri-rfc2396-2.14a from the list in RFC 3986.
# (3) Constraints removed for all tests that now pass.
# (4) Tests uri-rfc2396-1.6 uri-rfc2396-2.6 still fail.  The Tcl result has "/"
#     appended.  RFC 3986 wants to resolve:
#        "//g"     =>  "http://g"    (test uri-rfc2396-1.6)
#        "../.."   =>  "http://a/"   (test uri-rfc2396-1.20)
#     The RFC is therefore ambiguous as to whether "http://host/" or
#     "http://host" is the canonical form.  Both URIs refer to the same
#     resource.
# (5) Add tests uri-rfc2396-3.* from RFC 3986 Sec. 5.4.2 "Abnormal Examples".
# (6) Test uri-rfc2396-3.19 fails - constraints and explanation added.
# ------------------------------------------------------------------------------

# Test the "Normal Examples" from RFC 3986 Sec. 5.4.1.

test uri-rfc2396-1.1 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g:h]
} g:h

test uri-rfc2396-1.2 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g]
} http://a/b/c/g

test uri-rfc2396-1.3 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ./g]
} http://a/b/c/g

test uri-rfc2396-1.4 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g/]
} http://a/b/c/g/

test uri-rfc2396-1.5 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q /g]
} http://a/g

test uri-rfc2396-1.6 {uri::resolve RFC 3986 Sec. 5.4.1 is ambiguous - see comments in test file} {knownBug sf-tcllib-bug-581781} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q //g]
} http://g

test uri-rfc2396-1.7 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ?y]
} {http://a/b/c/d;p?y}

test uri-rfc2396-1.8 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g?y]
} http://a/b/c/g?y

test uri-rfc2396-1.9 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q \#s]
} {http://a/b/c/d;p?q#s}

test uri-rfc2396-1.10 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g\#s]
} http://a/b/c/g#s

test uri-rfc2396-1.11 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g?y\#s]
} http://a/b/c/g?y#s

test uri-rfc2396-1.12 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q \;x]
} {http://a/b/c/;x}

test uri-rfc2396-1.13 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g\;x]
} {http://a/b/c/g;x}

test uri-rfc2396-1.14 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g\;x?y#s]
} {http://a/b/c/g;x?y#s}

test uri-rfc2396-1.14a {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q {}]
} {http://a/b/c/d;p?q}

test uri-rfc2396-1.15 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q .]
} http://a/b/c/

test uri-rfc2396-1.16 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ./]
} http://a/b/c/

test uri-rfc2396-1.17 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ..]
} http://a/b/

test uri-rfc2396-1.18 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../]
} http://a/b/

test uri-rfc2396-1.19 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../g]
} http://a/b/g

test uri-rfc2396-1.20 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../..]
} http://a/

test uri-rfc2396-1.21 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../../]
} http://a/

test uri-rfc2396-1.22 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../../g]
} http://a/g


# This is the end of the "Normal Examples" from RFC 3986 Sec. 5.4.1.
# The tests below are similar, but the base URL omits the query-string "?q".

test uri-rfc2396-2.1 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g:h]
} g:h

test uri-rfc2396-2.2 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g]
} http://a/b/c/g

test uri-rfc2396-2.3 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ./g]
} http://a/b/c/g

test uri-rfc2396-2.4 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g/]
} http://a/b/c/g/

test uri-rfc2396-2.5 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p /g]
} http://a/g

test uri-rfc2396-2.6 {uri::resolve RFC 3986 Sec. 5.4.1 is ambiguous - see comments in test file} {knownBug sf-tcllib-bug-581781} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p //g]
} http://g

test uri-rfc2396-2.7 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ?y]
} {http://a/b/c/d;p?y}

test uri-rfc2396-2.8 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g?y]
} http://a/b/c/g?y

test uri-rfc2396-2.9 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p \#s]
} {http://a/b/c/d;p#s}

test uri-rfc2396-2.10 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g\#s]
} http://a/b/c/g#s

test uri-rfc2396-2.11 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g?y\#s]
} http://a/b/c/g?y#s

test uri-rfc2396-2.12 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p \;x]
} {http://a/b/c/;x}

test uri-rfc2396-2.13 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g\;x]
} {http://a/b/c/g;x}

test uri-rfc2396-2.14 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p g\;x?y#s]
} {http://a/b/c/g;x?y#s}

test uri-rfc2396-2.14a {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p {}]
} {http://a/b/c/d;p}

test uri-rfc2396-2.15 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p .]
} http://a/b/c/

test uri-rfc2396-2.16 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ./]
} http://a/b/c/

test uri-rfc2396-2.17 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ..]
} http://a/b/

test uri-rfc2396-2.18 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ../]
} http://a/b/

test uri-rfc2396-2.19 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ../g]
} http://a/b/g

test uri-rfc2396-2.20 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ../..]
} http://a/

test uri-rfc2396-2.21 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ../../]
} http://a/

test uri-rfc2396-2.22 {uri::resolve} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p ../../g]
} http://a/g


# Now tests from RFC 3986 Sec. 5.4.2. "Abnormal Examples".

test uri-rfc2396-3.1  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../../../g]
} http://a/g

test uri-rfc2396-3.2  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ../../../../g]
} http://a/g

test uri-rfc2396-3.3  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q /./g]
} http://a/g

test uri-rfc2396-3.4  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q /../g]
} http://a/g

test uri-rfc2396-3.5  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g.]
} http://a/b/c/g.

test uri-rfc2396-3.6  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q .g]
} http://a/b/c/.g

test uri-rfc2396-3.7  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g..]
} http://a/b/c/g..

test uri-rfc2396-3.8  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ..g]
} http://a/b/c/..g

test uri-rfc2396-3.9  {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ./../g]
} http://a/b/g

test uri-rfc2396-3.10 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q ./g/.]
} http://a/b/c/g/

test uri-rfc2396-3.11 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g/./h]
} http://a/b/c/g/h

test uri-rfc2396-3.12 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g/../h]
} http://a/b/c/h

test uri-rfc2396-3.13 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g\;x=1/./y]
} {http://a/b/c/g;x=1/y}

test uri-rfc2396-3.14 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g\;x=1/../y]
} http://a/b/c/y

test uri-rfc2396-3.15 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g?y/./x]
} http://a/b/c/g?y/./x

test uri-rfc2396-3.16 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g?y/../x]
} http://a/b/c/g?y/../x

test uri-rfc2396-3.17 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g#s/./x]
} http://a/b/c/g#s/./x

test uri-rfc2396-3.18 {uri::resolve abnormal examples} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q g#s/../x]
} http://a/b/c/g#s/../x

test uri-rfc2396-3.19 {uri::resolve abnormal examples RFC 3986 Sec. 5.4.2 advises avoiding this usage which is a loophole in RFC 1630.} {knownBug rfc1630-loophole-avoid-use} {
    uri::canonicalize [uri::resolve http://a/b/c/d\;p?q http:g]
} http:g


# ------------------------------------------------------------------------------

testsuiteCleanup
return

# ------------------------------------------------------------------------------
# Local Variables:
#   mode: tcl
#   indent-tabs-mode: nil
# End:
